rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // users コレクション
    // - 読み取り: 未認証でも可（explore/profile は公開ページのため）
    // - 書き込みは自分のドキュメントのみ
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // matches コレクション
    // - 読み取り: 自分が sender または receiver のドキュメントのみ
    // - 作成: 認証済みかつ sender_id が自分の UID のみ
    // - 更新: receiver（受信者）が status フィールドのみ変更可
    match /matches/{matchId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.sender_id ||
         request.auth.uid == resource.data.receiver_id);

      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.sender_id;

      allow update: if request.auth != null &&
        request.auth.uid == resource.data.receiver_id &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);
    }

    // 上記以外のすべてのドキュメントへのアクセスを拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
